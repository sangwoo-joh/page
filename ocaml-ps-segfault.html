<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google-site-verification" content="fgTBOMeN_sdI4JNBqYTzDwH0458H8AAVbF78jLjwudg" />
  <script type="text/javascript" src="/assets/vendor/moment.min.js"></script>
  <script type="text/javascript" src="/assets/js/site.js"></script>
  <!-- <script src="https://unpkg.com/cursor-effects@latest/dist/browser.js"></script> -->

  <title>
    
      OCaml로 PS 하...다가 세그폴트가?
    
  </title>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="OCaml로 PS 하…다가 세그폴트가?" />
<meta name="author" content="sangwoo-joh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="최애 언어로 문제를 풀어보는 시리즈긴 한데… 정식 시리즈는 아니고 쉬어가는 에피소드 정도 되겠다." />
<meta property="og:description" content="최애 언어로 문제를 풀어보는 시리즈긴 한데… 정식 시리즈는 아니고 쉬어가는 에피소드 정도 되겠다." />
<link rel="canonical" href="https://sangwoo-joh.github.io/ocaml-ps-segfault" />
<meta property="og:url" content="https://sangwoo-joh.github.io/ocaml-ps-segfault" />
<meta property="og:site_name" content="Caml Shaving" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OCaml로 PS 하…다가 세그폴트가?" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sangwoo-joh"},"dateModified":"2020-10-28T00:00:00+00:00","datePublished":"2020-10-28T00:00:00+00:00","description":"최애 언어로 문제를 풀어보는 시리즈긴 한데… 정식 시리즈는 아니고 쉬어가는 에피소드 정도 되겠다.","headline":"OCaml로 PS 하…다가 세그폴트가?","mainEntityOfPage":{"@type":"WebPage","@id":"https://sangwoo-joh.github.io/ocaml-ps-segfault"},"url":"https://sangwoo-joh.github.io/ocaml-ps-segfault"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://sangwoo-joh.github.io/feed.xml" title="Caml Shaving" />

  <link rel="apple-touch-icon" sizes="57x57" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://sangwoo-joh.github.io/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://sangwoo-joh.github.io/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://sangwoo-joh.github.io/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://sangwoo-joh.github.io/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://sangwoo-joh.github.io/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="https://sangwoo-joh.github.io/assets/icons/manifest.json">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Ubuntu" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="https://sangwoo-joh.github.io/assets/css/main.css" />
  <link rel="stylesheet" href="https://sangwoo-joh.github.io/assets/css/syntax.css" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J0C68FHJ6L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J0C68FHJ6L');
</script>


</head>
<body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="https://sangwoo-joh.github.io">/home/caml-shaving</a>
<center>
<h1>OCaml로 PS 하...다가 세그폴트가?</h1>
<h2>Embarassingly Obvious</h2>
</center>

<div class="post-edit-date">
  
  2020-10-28
</div>

<div class="post-edit-date">
  
  
</div>

<em><p align="right">

태그:



<a href="/archive?tag=dev"><span class="tag">dev</span></a>





<a href="/archive?tag=ocaml"><span class="tag">ocaml</span></a>




</p></em>


<p>최애 언어로 문제를 풀어보는 시리즈긴 한데… 정식 시리즈는 아니고
 쉬어가는 에피소드 정도 되겠다.</p>

<h3 id="대체-왜-런타임에러가-났던걸까">대체 왜 런타임에러가 났던걸까?</h3>
<p>예전 <a href="https://sangwoo-joh.github.io/ocaml-ps-word-count">포스팅</a> 에서
 풀었던 1152번 문제가 불현듯 떠올랐다. 입력으로 문자열을 받을 때
 <code class="language-plaintext highlighter-rouge">read_line</code>으로 받았더니 <strong>런타임에러</strong>가 떠서 실패했던 기억이
 있다. 아쉽게도 런타임에러 메시지를 악용하면 채점 테스트케이스를 알 수
 있기 때문에 백준 사이트에서 이를 제공해주진 않지만, 이 런타임에러는
 내가 짠 로직에서 발생한 게 아니라는 생각 정도는 가지고 있었다. 그러다
 얼마전 불현듯 “대체 그 런타임에러는 뭐였을까?” 라는 생각이 떨쳐지지
 않아 끝까지 파헤쳐보기로 했다.</p>

<h3 id="scanf는-에러가-안뜨네">Scanf는 에러가 안뜨네?</h3>
<p><code class="language-plaintext highlighter-rouge">read_line</code> 함수가 하는 일은 단순하다. 입력으로 들어오는 모든
 문자열을, 공백까지 포함해서 계속 쭉 읽어들이다가, 처음으로 줄바꿈
 문자가 나오는 순간 거기서 작업을 멈추고 그때까지 읽은 문자열을
 돌려주는 친구다.</p>

<p>좀 찾아보니 <code class="language-plaintext highlighter-rouge">Scanf</code>에서 포맷 형식을 지정하면 이것과 완전히 동일한
 일을 할 수 있겠더라: <code class="language-plaintext highlighter-rouge">Scanf.scanf "%[^\n]"</code> 로 읽어들이면, <code class="language-plaintext highlighter-rouge">[ ]</code> 안에
 있는 정규표현식에 맞춰서 입력을 읽어들인다. 그래서 간단하게 <code class="language-plaintext highlighter-rouge">^\n</code>, 즉
 <em>줄바꿈 문자 말고 전부 다</em> 읽도록 하면 된다.</p>

<p>놀라운 건 이렇게 입력 함수만 바꿨을 뿐인데 예전에 런타임에러가 떠서
 실패했던 코드가 그대로 통과했다. 분명히 <code class="language-plaintext highlighter-rouge">read_line</code>에 버그가
 있어보였다.</p>

<h3 id="디스커스-커뮤니티에-물어보기">디스커스 커뮤니티에 물어보기</h3>
<p>어떤 언어를 쓰다가 모르는게 생겼을 때는 보통 그 언어 사용자나
 개발자가 주로 모이는 커뮤니티에 물어보는 것이 국룰이다. 다행히
 얼마전부터 OCaml에도 <a href="https://discuss.ocaml.org">커뮤니티</a>가 생겨서
 종종 눈팅을 하곤 했었는데, 이 기회에 여기에 질문을 올려보기로 했다.</p>

<p>하지만 질문은 잘 하는 게 중요하다. 대체 이 현상을 뭐라고
 질문해야할까? 일단 <code class="language-plaintext highlighter-rouge">"[^\n]"</code> 로 <code class="language-plaintext highlighter-rouge">Scanf</code> 하면 잘 통과한다는 사실까진
 알아냈으니, 이걸 정리해서 <a href="https://discuss.ocaml.org/t/how-different-is-the-behaviour-of-read-line-and-scanf-scanf-n/6564"><code class="language-plaintext highlighter-rouge">read_line</code> 과 <code class="language-plaintext highlighter-rouge">Scanf.scanf "%[^\n]"</code>
 함수의 동작이 얼마나
 다른가요?</a>
 라는 글을 작성했다.</p>

<p>사실 커뮤니티가 생기긴 했지만, 크게 기대하지 않았다. 그런데 한 착한
 해커분께서 직접(!) 백준 사이트에 가입해서, 1152번 문제를 똑같은
 코드로 풀어본 뒤, 이것저것 테스트해보다가 <code class="language-plaintext highlighter-rouge">Gc</code>를 한번이라도 건들면
 <code class="language-plaintext highlighter-rouge">read_line</code>을 쓰더라도 런타임에러가 나지 않는다는 사실을
 발견했다. 그리고 더불어 채점 버전인 4.07.0 버전의 바이트코드
 컴파일러의 가비지 콜렉션에 버그가 있다는 것도 알려줬다. 오호. 슬슬
 해결의 실마리가 보이는듯 했다.</p>

<h3 id="당황스러울-정도로-명백한">“당황스러울 정도로 명백한”</h3>

<p>과연 찾아보니 <a href="https://github.com/ocaml/ocaml/pull/1896">Major GC Crash를 수정하는
 PR</a>을 확인할 수
 있었다. 수정한 개발자의 한 코멘트가 인상적이었다: “The fix is
 <strong>embarassingly obvious.</strong>” 코드를 살펴보니 정말 딱 한줄
 수정했더라. <code class="language-plaintext highlighter-rouge">caml_fl_allocate</code> 라는 함수가 정확히 뭘 하는진
 모르겠지만 (아마도 free list에 뭔가 할당하는 함수이지 않을까…),
 상수 크기의 버퍼를 만들고 반복문에서 그 버퍼에 뭔가를 저장하는데, 이
 버퍼의 인덱스를 넘어버리는 버퍼 오버플로우가 있었던 것이다. 아마도
 <code class="language-plaintext highlighter-rouge">read_line</code>이 동작할 때 이 함수와 상호작용하다가 터진 게 아닐까?</p>

<p>여기까지 알아냈으면 내가 할 수 있는 일은 좁혀졌다.</p>
<ul>
  <li>일단 <code class="language-plaintext highlighter-rouge">ignore (Gc.get ()) ;</code> 과 같은 우회 코드를 삽입해서
<code class="language-plaintext highlighter-rouge">read_line</code>을 쓰거나, 아니면 <code class="language-plaintext highlighter-rouge">Scanf.scanf</code>를 쓰거나 해서 문제는
계속 풀 수 있다. <code class="language-plaintext highlighter-rouge">Scanf.scanf</code> 쪽이 좀 더 느리긴 하지만.</li>
  <li>채점 컴파일러에 버그가 있는게 명백하니, 업그레이드를
요청해야겠다. 겸사겸사 바이트 코드로 컴파일하는 현재의 컴파일
커맨드를 네이티브 코드로 바꿔달라고도 해야겠다.</li>
</ul>

<h3 id="백준-만세">백준 만세</h3>
<p>백준 온라인 저지 사이트의 기능 요청을 받는
 <a href="https://github.com/startlink/boj-feature-request">깃허브</a>가
 있더라. 여기에 정성스럽게
 <a href="https://github.com/Startlink/BOJ-Feature-Request/issues/186">이슈를</a>
 <a href="https://github.com/Startlink/BOJ-Feature-Request/issues/188">올렸다</a>. 지금
 쓰이는 컴파일러 버전에 심각한 버그가 있으니 올려주세요. 네이티브
 컴파일 해주세요. 더불어 자바랑 유사하니까 시간 제한 좀 늘려주세요.</p>

<p>그리고 인고의 기다림 끝에 드디어!!! 백준 온라인 저지에 모든 것이
 반영되었다. 백준 만만세! 이제 백준 사이트에서는</p>
<ul>
  <li>OCaml 4.11.1 버전을 사용하며,</li>
  <li><code class="language-plaintext highlighter-rouge">ocamlopt -O2</code> 커맨드로  네이티브 코드 컴파일이 된다.</li>
</ul>

<p>그리고 백준님께서 테스트해본 결과 네이티브 코드의 속도가 충분히
 빨라서 자바와 같은 시간/메모리 제한을 할 필요는 없어보인다고 답글을
 달아주셨다. 비록
 <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/ocaml-java.html">벤치마크</a>에서는
 대부분 자바에 시간은 밀리긴 했지만, 메모리 사용량은 일단
 월등했다. 그래서 직접 예전 시간초과로 실패했던 몇몇 문제를 그대로
 제출해보니, 과연 잘 통과하더라.</p>

<p>역시 네이티브 코드 컴파일러야. 성능 확실하구만.</p>

<h3 id="마무리">마무리</h3>
<p>오랜만에 재밌었다. 사실 그냥 넘어갈 수도 있었는데, “대체 왜
 런타임에러가 나지?” 라는 궁금증을 도저히 떨칠 수 없어서 시작한 일이
 결국 채점 컴파일러까지 업그레이드하게 되었다.  친절하게 답변해준
 OCaml 커뮤니티와 백준님께도 감사의 마음을 표한다. 뉴비들에게 친절한
 커뮤니티는 항상 옳다.</p>

<p>이제 찬찬히 단계 별로 문제를 풀어보도록 해야지.</p>


<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<br />

<div>
  <script src="https://giscus.app/client.js"
          data-repo="sangwoo-joh/reactions"
          data-repo-id="R_kgDOJFNVQw"
          data-category="Comments"
          data-category-id="DIC_kwDOJFNVQ84CUox9"
          data-mapping="pathname"
          data-strict="1"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="light_high_contrast"
          data-lang="ko"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>
</div>

<br />

      </div>
    </main>

    
    <footer>
  <a href="/feed.xml">rss</a>
  <a href="mailto:work.sangwoo.joh@gmail.com">mail</a>
  <a href="https://www.linkedin.com/in/sangwoo-joh">linkedin</a>
  <a href="https://github.com/sangwoo-joh">github</a>
  <p class="copyright text-muted">Copyright &copy; sangwoo-joh 2023</p>
  <small><a target="_blank" href="https://icons8.com/icons/set/--camel">Camel icon</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a></small>
</footer>

  </body>
</html>
